<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="../js/sessao.js"></script>


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Press+Start+2P&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
        rel="stylesheet">

    <link rel="icon" href="../assets/icon/icone.svg">
    <link rel="stylesheet" href="../css/dashboards.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <title>Comunidade Junimo | Dashboard</title>
</head>

<body
    onload="validarSessao(), mostrarDados(), obterDadosGenero(), obterDadosPet(), obterDadosFazenda(), obterDadosPerfeicao()">
    <div class="construcao-pai">
        <div id="alerta_construcao" class="construcao">
            <h1>Robin está trabalhando!</h1>
            <img src="../assets/img/robin_construcao.png">
            <p>Esse espaço está em<br>construção. Volte depois!</p>
        </div>
    </div>

    <main class="main-dashboard">
        <div class="navbar-lateral">
            <div class="lateral-saudacoes">
                <div class="lateral-titulo">
                    <span id="foto_usuario"></span>
                    <h2>Olá, <span id="b_usuario">usuário</span>!</h2>
                    <p>Sua mente está cheia de pensamentos sobre <span id="coisa_usuario"></span>.</p>
                </div>

                <div class="lateral-opcoes">
                    <a href="./mural.html" class="opcao">
                        <img src="../assets/img/regador.svg">
                        <span>Seu Espaço</span>
                    </a>

                    <a href="./dashboard.html" class="opcao">
                        <img src="../assets/img/dashboard.svg">
                        <span id="selecionada">Dashboard</span>
                    </a>

                    <a href="./comunidade.html" class="opcao">
                        <img src="../assets/img/comunidade.svg">
                        <span>Comunidade</span>
                    </a>

                    <a onclick="mostrarAlerta()" class="opcao">
                        <img src="../assets/img/cruzadinha.svg">
                        <span>Cruzadinha</span>
                    </a>
                </div>
            </div>

            <div onclick="limparSessao()" class="lateral-sair">
                <img src="../assets/img/sair.svg" alt="Sair">
                <span>Sair</span>
            </div>
        </div>

        <div class="container-dashboard">
            <div class="navbar">
                <a href="/">
                    <img src="../assets/img/topo.png" alt="topo Stardew Valley">
                </a>

                <div class="opcoes">
                    <a href="./mural.html">
                        <img src="../assets/img/espaco-topo.png">
                    </a>
                    <a href="./dashboard.html">
                        <img src="../assets/img/dashboard-topo.png">
                    </a>
                    <a onclick="mostrarAlerta()">
                        <img src="../assets/img/comunidade-topo.png">
                    </a>
                </div>
            </div>

            <div class="principal-dashboard">
                <div class="metricas">
                    <div class="metrica">
                        <span>
                            <img src="../assets/img/idade.svg">
                        </span>
                        <div class="metrica-titulo">
                            <h1 id="idade_media">20 anos</h1>
                            <p>Idade média dos jogadores</p>
                        </div>
                    </div>

                    <div class="metrica">
                        <span>
                            <img id="favoritado" src="../assets/img/robin.png" alt="">
                        </span>
                        <div class="metrica-titulo">
                            <h1 id="personagem_favoritado">Robin</h1>
                            <p>Personagem mais favoritado</p>
                        </div>
                    </div>

                    <div class="metrica">
                        <span>
                            <img src="../assets/img/trofeu.svg">
                        </span>
                        <div class="metrica-titulo">
                            <h1 id="porcentagem_perfeicao">45%</h1>
                            <p>Alcançaram a verdadeira perfeição</p>
                        </div>
                    </div>
                </div>

                <div class="graficos">
                    <div class="grupo-graficos">
                        <div class="grafico-um grafico">
                            <h4>Perfeição e Verdadeira Perfeição</h4>
                            <canvas id="grafico_perfeicao"></canvas>
                        </div>



                        <div class="grafico-dois grafico">
                            <h4>Tipo de Fazenda em Relação ao Total de Jogadores</h4>
                            <canvas id="grafico_fazenda_tipo"></canvas>
                        </div>
                    </div>

                    <div class="grupo-graficos">
                        <div class="grafico-tres grafico">
                            <h4>Gênero em Relação ao Total de Jogadores</h4>
                            <canvas id="grafico_genero"></canvas>
                        </div>

                        <div class="grafico-quatro grafico">
                            <h4>Tipo de Pet em Relação ao Total de Jogadores</h4>
                            <canvas id="grafico_pet"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>

<script>


    function obterDadosGenero() {
        fetch("/dashboard/genero", { cache: 'no-store' }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log("Dados sobre gênero recebido: ", resposta)
                    plotarDadosGenero(resposta);
                })
            } else {
                console.error("Nenhum dado encontrado para Gêneros.");
            }
        }).catch(function (error) {
            console.error("Erro no fetch do gênero.");
        });
    }

    function plotarDadosGenero(resposta) {
        console.log("Plotando Gênero no gráfico");

        var generoOpcao = [];
        var generoValor = [];

        for (var i = 0; i < resposta.length; i++) {
            var dadoAtual = resposta[i];

            if (dadoAtual.genero == "M") {
                generoOpcao.push("Masculino");
            } else if (dadoAtual.genero == "F") {
                generoOpcao.push("Feminino");
            } else {
                generoOpcao.push("Outros");
            }

            generoValor.push(dadoAtual.generoTotal);
        }


        const graficoGenero = document.getElementById('grafico_genero');

        new Chart(graficoGenero, {
            type: 'pie',
            data: {
                labels: generoOpcao,
                datasets: [{
                    label: 'Total de jogadores',
                    data: generoValor,
                    borderWidth: 1,
                    backgroundColor: ['#E65100', '#FF9800', '#FFB74D']
                }]
            }
        });


    }

    function obterDadosPet() {
        fetch("/dashboard/tipoPet", { cache: 'no-store' }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log("Dados sobre gênero recebido: ", resposta)
                    plotarDadosPet(resposta);
                })
            } else {
                console.error("Nenhum dado encontrado para Tipo de Pet.");
            }
        }).catch(function (error) {
            console.error("Erro no fetch do Tipo de Pet.");
        });
    }

    function plotarDadosPet(resposta) {
        console.log("Plotando Tipos de Pet no gráfico");

        var tiposPet = [];
        var tiposPetValor = [];

        for (var i = 0; i < resposta.length; i++) {
            var dadoAtual = resposta[i];

            tiposPet.push(dadoAtual.petFavorito);
            tiposPetValor.push(dadoAtual.totalEscolhido);
        }


        const graficoPet = document.getElementById('grafico_pet');

        new Chart(graficoPet, {
            type: 'bar',
            data: {
                labels: tiposPet,
                datasets: [{
                    label: 'Total de jogadores',
                    data: tiposPetValor,
                    borderWidth: 1,
                    backgroundColor: ['#003400', '#006414', '#009929']
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });

    }

    function obterDadosFazenda() {
        fetch("/dashboard/tipoFazenda", { cache: 'no-store' }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log("Dados sobre tipo de fazenda recebido: ", resposta)
                    plotarDadosFazenda(resposta);
                })
            } else {
                console.error("Nenhum dado encontrado para Tipos de Fazenda.");
            }
        }).catch(function (error) {
            console.error("Erro no fetch do tipo de fazenda.");
        });
    }

    function plotarDadosFazenda(resposta) {

        console.log("Plotando Tipos de Pet no gráfico");

        var tiposFazenda = [];
        var tiposFazendaValor = [];

        for (var i = 0; i < resposta.length; i++) {
            var dadoAtual = resposta[i];

            tiposFazenda.push(dadoAtual.tipoFazenda);
            tiposFazendaValor.push(dadoAtual.totalEscolhido);
        }

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: tiposFazenda,
            datasets: [{
                label: 'Total de jogadores',
                data: tiposFazendaValor,
                backgroundColor: ['#800000', '#8B0000', '#B22222', '#A52A2A', '#FF6347', 'FF7F50', '#FFA07A']
            }]
        };

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados
        };

        // Adicionando gráfico criado em div na tela
        new Chart(
            document.getElementById("grafico_fazenda_tipo"),
            config
        );
    }

    function obterDadosPerfeicao() {
        fetch("/dashboard/perfeicao", { cache: 'no-store' }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log("Dados sobre perfeição geral recebido: ", resposta)
                    plotarDadosPerfeicao(resposta[0]);
                })
            } else {
                console.error("Nenhum dado encontrado para perfeição geral.");
            }
        }).catch(function (error) {
            console.error("Erro no fetch do perfeição geral.");
        });
    }

    function plotarDadosPerfeicao(resposta) {
        console.log("Plotando perfeição geral no gráfico");

        var totalUsuarios = Number(resposta.totalUsuarios);
        var perfeicao = Number(resposta.alcancaramPerfeicao);
        var verdadeiraPerfeicao = Number(resposta.alcancaramVerdadeiraPerfeicao);

        var naoAlcancouPerfeicao = totalUsuarios - perfeicao;
        var naoAlcandouVerdadeiraPerfeicao = totalUsuarios - verdadeiraPerfeicao;

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: ['Perfeição', 'Verdadeira Perfeição'],
            datasets: [{
                label: 'Não Alcançou',
                data: [naoAlcancouPerfeicao, naoAlcandouVerdadeiraPerfeicao],
                backgroundColor: '#008489',
                borderWidth: 1
            },
            {
                label: 'Alcançou',
                data: [perfeicao, verdadeiraPerfeicao],
                backgroundColor: '#93C2C4',
                borderWidth: 1
            }
            ]
        };

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
            options: {
                scales: {
                    y: { beginAtZero: true },
                    x: { beginAtZero: true }
                }
            }
        };

        // Adicionando gráfico criado em div na tela
        new Chart(
            document.getElementById("grafico_perfeicao"),
            config
        );
    }

    function mostrarDados() {
        fetch("/dashboard/idadeMedia").then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    idade_media.innerHTML = `${resposta.idadeMedia} anos`;
                })
            } else {
                throw ('Houve um erro na API!');

            }
        }).catch(function (resposta) {
            console.error(resposta);
            alert('Erro')
        })

        fetch("/dashboard/alcancaramPerfeicao").then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    var total = resposta.totalUsuarios;
                    var alcancaram = resposta.alcancaramVerdadeiraPerfeicao;
                    var porcPerfeicao = alcancaram / total * 100;

                    porcentagem_perfeicao.innerHTML = `${porcPerfeicao.toFixed(0)}%`;

                })
            } else {
                throw ('Houve um erro na API!');

            }
        }).catch(function (resposta) {
            console.error(resposta);
            alert('Erro')
        })

        fetch("/dashboard/personagemFav").then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    var maisFavoritado = resposta.nomePersonagem;

                    personagem_favoritado.innerHTML = maisFavoritado;
                    favoritado.src = `../assets/img/${maisFavoritado}.png`;

                })
            } else {
                throw ('Houve um erro na API!');

            }
        }).catch(function (resposta) {
            console.error(resposta);
            alert('Erro')
        })


    }


    function mostrarAlerta() {
        alerta_construcao.style.opacity = "1";

        setTimeout(() => {
            alerta_construcao.style.opacity = "0";
        }, 3000);
    }

</script>

</html>